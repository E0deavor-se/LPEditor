@using System.Net.Http.Json
@using System.Text.Json
@using LPEditorApp.Models.Ai
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Navigation

<section class="ai-panel">
    <h3>AIでLPを生成</h3>
    <div class="field">
        <label>業種</label>
        <input class="text" @bind-value="Input.Industry" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>会社名・ブランド名</label>
        <input class="text" @bind-value="Input.BrandName" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>キャンペーン概要</label>
        <textarea class="text" rows="3" @bind-value="Input.CampaignOverview" @bind-value:event="oninput"></textarea>
    </div>
    <div class="field">
        <label>オファー</label>
        <input class="text" @bind-value="Input.Offer" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>条件</label>
        <input class="text" @bind-value="Input.Conditions" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>期間</label>
        <input class="text" @bind-value="Input.Period" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>対象者</label>
        <input class="text" @bind-value="Input.Target" @bind-value:event="oninput" />
    </div>
    <div class="field">
        <label>トーン</label>
        <select class="text" @bind="Input.Tone">
            <option value="casual">カジュアル</option>
            <option value="formal">フォーマル</option>
        </select>
    </div>
    <div class="field">
        <label>目的</label>
        <select class="text" @bind="Input.Goal">
            <option value="acquisition">新規送客</option>
            <option value="activation">利用促進</option>
            <option value="retention">再来店</option>
            <option value="revenue">客単価UP</option>
        </select>
    </div>
    <div class="field">
        <label>必須文言</label>
        <textarea class="text" rows="2" @bind-value="Input.RequiredStatements" @bind-value:event="oninput"></textarea>
    </div>
    <div class="field">
        <label>禁止表現</label>
        <textarea class="text" rows="2" @bind-value="Input.ProhibitedExpressions" @bind-value:event="oninput"></textarea>
    </div>
    <div class="field">
        <label>注意点</label>
        <textarea class="text" rows="3" @bind-value="Input.Notes" @bind-value:event="oninput"></textarea>
    </div>

    <div class="ai-actions">
        <button type="button" class="btn" disabled="@IsLoading" @onclick="GenerateAsync">AIでLPを生成</button>
        <button type="button" class="btn" disabled="@(IsLoading || Result is null)" @onclick="ApplyAsync">この生成結果を反映</button>
        <button type="button" class="btn" disabled="@IsLoading" @onclick="RegenerateAsync">やり直し</button>
    </div>

    @if (IsLoading)
    {
        <div class="ai-status">生成中...</div>
    }
    else if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="ai-error">@ErrorMessage</div>
    }
    else if (!string.IsNullOrWhiteSpace(SuccessMessage))
    {
        <div class="ai-success">@SuccessMessage</div>
    }

    @if (Result is not null)
    {
        <div class="ai-result">
            <h4>生成結果</h4>
            <div class="ai-result-meta">
                <div>タイトル: @Result.Meta?.Title</div>
                <div>トーン: @Result.Meta?.Tone</div>
                <div>目的: @Result.Meta?.Goal</div>
            </div>
            <div class="ai-result-sections">
                @foreach (var sectionItem in Result.Sections)
                {
                    <div class="ai-result-section">@sectionItem.Type (@sectionItem.Id)</div>
                }
            </div>
            <textarea class="text ai-json" rows="10" readonly>@RawJson</textarea>
        </div>
    }
</section>

@code {
    [Parameter]
    public EventCallback<LpBlueprint> OnApply { get; set; }

    private AiGenerateLpRequest Input { get; set; } = new();
    private bool IsLoading { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private LpBlueprint? Result { get; set; }
    private string RawJson { get; set; } = string.Empty;

    private async Task GenerateAsync()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsLoading = true;
        Result = null;
        RawJson = string.Empty;

        try
        {
            var client = ClientFactory.CreateClient();
            client.BaseAddress = new Uri(Navigation.BaseUri);
            var response = await client.PostAsJsonAsync("api/ai/generate-lp", Input);
            var raw = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode)
            {
                ErrorMessage = "AI生成に失敗しました。入力内容を見直して再度お試しください。";
                return;
            }

            RawJson = raw;
            Result = JsonSerializer.Deserialize<LpBlueprint>(raw, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (Result is null)
            {
                ErrorMessage = "生成結果の解析に失敗しました。";
                return;
            }

            SuccessMessage = "生成結果を取得しました。";
        }
        catch
        {
            ErrorMessage = "AI生成に失敗しました。時間をおいて再度お試しください。";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private Task RegenerateAsync()
    {
        return GenerateAsync();
    }

    private async Task ApplyAsync()
    {
        if (Result is null)
        {
            return;
        }

        await OnApply.InvokeAsync(Result);
        SuccessMessage = "編集画面に反映しました。";
    }
}
